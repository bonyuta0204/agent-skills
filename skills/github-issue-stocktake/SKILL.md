---
name: github-issue-stocktake
description: GitHub Issueの棚卸しを実行する。既存Issueを5件前後のバッチで調査し、ステータス更新、担当者アサイン、重複統合、クローズ判断、ネクストアクション整理、一次調査コメント投稿を行うときに使う。仕様書・画面項目定義・必要時のFigmaと現行実装を突合して意思決定するタスクで使う。
---

# GitHub Issue Stocktake

## Overview
- 既存Issueをバッチ処理で棚卸しする。
- 各Issueで「実装」「仕様書」「画面項目定義（必要ならFigma）」を突合して判断する。
- ユーザーの明示指示がない限り、新規Issueを起票しない。

## Inputs
1. 対象リポジトリと対象Issue番号（または範囲）を確定する。
2. バッチサイズを確定する（デフォルト5件）。
3. 実行可能操作を確定する（コメント、アサイン、クローズ、重複統合）。
4. 判定に使う参照先（仕様書、画面項目定義、Figma）を確定する。

## Batch Workflow
1. Issue状態を取得する。
- `gh issue view <番号> --comments` で本文・履歴・最新判断を確認する。
- 未確定事項と既存合意を分離してメモする。

2. 根拠を調査する。
- 実装は `rg` を起点に該当コードを読む。
- 仕様書と画面項目定義を確認し、実装と差分を明文化する。
- UI仕様が曖昧な場合のみFigmaを追加確認する。

3. 判定する。
- `Close` : 再現しない、仕様変更で吸収済み、重複、実装済みで問題解消。
- `Keep Open` : 未解決、または実装/仕様の差分が残る。
- `Spec Confirming` : 仕様根拠が不足し、仕様確認待ち。

4. 反映する。
- 合意済みユーザーをアサインする。
- クローズ時は、先にMarkdownコメントで根拠を残してからクローズする。
- クローズできない場合は一次調査コメントを投稿する。

5. バッチ報告する。
- 実施Issue、実行アクション、コメントURLを列挙する。
- 保留Issueは「不足根拠」と「次アクション」を1行で示す。

## Decision Rules
- 重複クローズ時は必ず集約先Issue番号を明記する。
- 「直っている」判定は現行実装で根拠を確認してから行う。
- 「仕様変更でクローズ」は変更後仕様の根拠を添える。
- 仕様書/画面項目定義を参照した場合は、IssueコメントにNotionページURLを必ず明記する。
- 根拠不足時は無理にクローズせず、調査結果と不足点を残す。
- GitHubへ投稿する本文は、必ずGitHub Flavored Markdown（GFM）で構造化する。
- 単なる1段落のプレーンテキスト投稿は不可。最低限「見出し1つ + 箇条書き1つ」を含める。

## GitHub Comment Format Rules (Mandatory)
- すべての一次調査コメントは `.md` ファイルを作ってから投稿する。
- 投稿前に `cat` で最終本文を確認し、見出し・箇条書き・コード表記が崩れていないことを確認する。
- ファイルパス/コマンド/識別子はバッククォートで囲む（例: `` `app/foo.ts:120` ``）。
- 参照Issueは `#123` の形式で明記する。
- クローズ時は「Markdownコメント投稿 -> issue close」の順で実行し、根拠を履歴に残す。

## Comment Templates
### 一次調査
```md
## 一次調査メモ

### 現象
- ...

### 調査結果
- 再現結果: ...
- 実装確認: `<path>:<line>` ...
- 仕様確認: 仕様書 <Notion URL> / 画面項目定義 <Notion URL>（必要ならFigma <URL>）

### 結論
- 判定: クローズ可 / 継続調査 / 仕様確認中
- 方針案: ...
```

### 重複クローズ
```md
## クローズ理由（重複）

- 重複のためクローズします。
- 追跡は #<集約先Issue番号> に集約します。
```

### 仕様確認中
```md
## 判定: 仕様確認中

- 仕様書・画面項目定義で明記を確認できなかったため、現時点は仕様確認中として扱います。
- 確認待ち: <確認対象と担当>
```

## Command Patterns
```bash
gh issue view <番号> --comments
cat > /tmp/issue-<番号>-comment.md <<'EOF'
## 一次調査メモ
...
EOF
cat /tmp/issue-<番号>-comment.md
gh issue comment <番号> --body-file /tmp/issue-<番号>-comment.md
gh issue edit <番号> --add-assignee <user>
gh issue close <番号>
```

## Output Contract
バッチごとに次を返す。
1. 対応済みIssue番号と実行アクション
2. 投稿コメントURL
3. オープン維持したIssueと理由
4. 次バッチ候補（5件）
